<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Dashboard - AACEM Coaching</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="icon" href="logo.png" type="image/png">

  <style>
    :root {
      --primary: #0d6efd;
      --secondary: #8a8d93;
      --success: #198754;
      --danger: #dc3545;
      --warning: #ffc107;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f9fa;
    }

    /* Header */
    .navbar {
      background-color: rgb(45, 107, 107) !important;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1030;
    }

    .navbar .navbar-brand i {
      color: #00b4d8;
    }

    /* Sidebar */
    #studentSidebar {
      position: fixed;
      top: 56px;
      left: 0;
      width: 250px;
      height: calc(100vh - 56px);
      background-color: #343a40;
      padding-top: 20px;
      overflow-y: auto;
    }

    #studentSidebar h4 {
      padding-left: 15px;
      margin-bottom: 10px;
      color: #00b4d8;
    }

    #studentSidebar .nav-link {
      color: #adb5bd;
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      transition: 0.3s;
    }

    #studentSidebar .nav-link i {
      margin-right: 10px;
      color: #0dcaf0;
    }

    #studentSidebar .nav-link:hover,
    #studentSidebar .nav-link.active {
      background: linear-gradient(90deg, #00b4d8, #0077b6);
      color: #fff;
    }

    /* Main Content */
    #studentMain {
      margin-left: 250px;
      padding: 30px 20px 20px 20px;
      height: calc(100vh - 56px);
      overflow-y: auto;
    }

    /* Cards */
    .studentCard {
      background-color: #fff;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .studentCard:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .studentCard h4 i {
      color: #0077b6;
    }

    /* Tables */
    table {
      border-radius: 10px;
      overflow: hidden;
      background-color: #fff;
    }

    .table th, .table td {
      vertical-align: middle !important;
    }

    /* Buttons */
    .btn-success {
      background-color: #0077b6;
      border: none;
      transition: 0.3s;
    }

    .btn-success:hover {
      background-color: #00b4d8;
    }

    /* Loading States */
    .loading {
      text-align: center;
      padding: 20px;
      color: #6c757d;
    }

    .spinner-border {
      width: 2rem;
      height: 2rem;
    }

    /* Progress Bars */
    .progress {
      height: 25px;
      border-radius: 12px;
    }

    .progress-bar {
      border-radius: 12px;
      font-weight: 600;
    }

    /* Badges */
    .badge {
      font-size: 0.8em;
      padding: 6px 12px;
    }

    /* Scrollbar */
    #studentMain::-webkit-scrollbar {
      width: 10px;
    }

    #studentMain::-webkit-scrollbar-track {
      background: #e9ecef;
      border-radius: 10px;
    }

    #studentMain::-webkit-scrollbar-thumb {
      background: #0077b6;
      border-radius: 10px;
    }

    #studentMain::-webkit-scrollbar-thumb:hover {
      background: #00b4d8;
    }

    /* Responsive */
    @media (max-width: 992px) {
      #studentSidebar {
        position: relative;
        width: 100%;
        height: auto;
        top: 0;
      }

      #studentMain {
        margin-left: 0;
        height: auto;
        padding-top: 20px;
      }
    }

    /* Stats Cards */
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .stats-card .number {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stats-card .label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    /* Attendance Details */
    .attendance-details {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s ease;
    }

    .attendance-details.show {
      max-height: 1000px;
    }

    .attendance-toggle {
      cursor: pointer;
      color: #0077b6;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      margin-top: 15px;
      padding: 8px 15px;
      border: 1px solid #0077b6;
      border-radius: 5px;
      transition: all 0.3s ease;
    }

    .attendance-toggle:hover {
      background-color: #0077b6;
      color: white;
    }

    .attendance-toggle.active {
      background-color: #0077b6;
      color: white;
    }

    .attendance-toggle i {
      transition: transform 0.3s ease;
    }

    .attendance-toggle.active i {
      transform: rotate(180deg);
    }
    
    /* Login Modal */
    .login-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    
    .login-modal.show {
      display: flex;
    }
    
    .login-box {
      background: white;
      padding: 40px;
      border-radius: 15px;
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
  </style>
</head>
<body>

  <!-- Login Modal -->
  <div id="loginModal" class="login-modal">
    <div class="login-box">
      <h3 class="mb-4"><i class="fas fa-lock text-danger"></i> Authentication Required</h3>
      <p class="mb-4">Please login to access the student dashboard</p>
      <button class="btn btn-primary btn-lg" onclick="redirectToLogin()">
        <i class="fas fa-sign-in-alt me-2"></i>Go to Login Page
      </button>
    </div>
  </div>

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <i class="fas fa-graduation-cap me-2"></i>AACEM Institute
      </a>
      <div>
        <span class="text-white me-3" id="welcomeText">Welcome, Student</span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav id="studentSidebar" class="col-md-3 col-lg-2 d-none d-md-block bg-dark sidebar">
        <div class="position-sticky pt-3">
          <h4 class="text-white">Student Dashboard</h4>
          <ul class="nav flex-column mt-3">
            <li class="nav-item"><a class="nav-link active" href="#profile"><i class="fas fa-user me-2"></i>Profile</a></li>
            <li class="nav-item"><a class="nav-link" href="#attendance"><i class="fas fa-chart-bar me-2"></i>Attendance</a></li>
            <li class="nav-item"><a class="nav-link" href="#timetable"><i class="fas fa-calendar-alt me-2"></i>Timetable</a></li>
            <li class="nav-item">
                <a class="nav-link" href="#study-materials">
                    <i class="fas fa-file-pdf me-2"></i>Study Materials
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#syllabus">
                    <i class="fas fa-book-open me-2"></i>Course Syllabus
                </a>
            </li>
            <li class="nav-item"><a class="nav-link" href="#results"><i class="fas fa-file-alt me-2"></i>Results</a></li>
            <li class="nav-item"><a class="nav-link" href="#fees"><i class="fas fa-money-bill-wave me-2"></i>Fees</a></li>
            <li class="nav-item"><a class="nav-link" href="#notice"><i class="fas fa-bullhorn me-2"></i>Notices</a></li>
          </ul>
        </div>
      </nav>

      <!-- Main Content -->
      <main id="studentMain" class="col-md-9 col-lg-10 ms-sm-auto px-md-4">
        
        <!-- Profile -->
        <section id="profile" class="mt-5 mb-4">
          <div class="studentCard p-4 shadow-sm">
            <h4><i class="fas fa-user me-2"></i>My Profile</h4>
            <div id="profileContent" class="loading">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading profile data...</p>
            </div>
          </div>
        </section>

        <!-- Attendance -->
        <section id="attendance" class="mb-4">
          <div class="studentCard p-4 shadow-sm">
            <h4><i class="fas fa-chart-bar me-2"></i>Attendance</h4>
            <div id="attendanceContent" class="loading">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading attendance data...</p>
            </div>
          </div>
        </section>

        <!-- Timetable -->
        <section id="timetable" class="mb-4">
          <div class="studentCard p-4 shadow-sm">
            <h4><i class="fas fa-calendar-alt me-2"></i>Timetable</h4>
            <div id="timetableContent" class="loading">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading timetable...</p>
            </div>
          </div>
        </section>

        <!-- Results -->
        <section id="results" class="mb-4">
          <div class="studentCard p-4 shadow-sm">
            <h4><i class="fas fa-file-alt me-2"></i>Results</h4>
            <div id="resultsContent" class="loading">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading results...</p>
            </div>
          </div>
        </section>

        <!-- Fees -->
        <section id="fees" class="mb-4">
          <div class="studentCard p-4 shadow-sm">
            <h4><i class="fas fa-money-bill-wave me-2"></i>Fees</h4>
            <div id="feesContent" class="loading">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading fee details...</p>
            </div>
          </div>
        </section>

        <!-- Notices -->
        <section id="notice" class="mb-4">
          <div class="studentCard p-4 shadow-sm">
            <h4><i class="fas fa-bullhorn me-2"></i>Notice Board</h4>
            <div id="noticesContent" class="loading">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading notices...</p>
            </div>
          </div>
        </section>

        <!-- Syllabus Section -->
      <section id="syllabus" class="mb-4">
          <div class="studentCard p-4 shadow-sm">
              <h4><i class="fas fa-book-open me-2 text-primary"></i>Course Syllabus</h4>
              <div id="syllabusContent" class="loading">
                  <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-2">Loading course syllabus...</p>
              </div>
          </div>
      </section>

        <!-- Study Materials/PDFs -->
        <section id="study-materials" class="mb-4">
          <div class="studentCard p-4 shadow-sm">
              <h4><i class="fas fa-file-pdf me-2 text-danger"></i>Study Materials</h4>
              <div id="pdfsContent" class="loading">
                  <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-2">Loading study materials...</p>
              </div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // API Configuration
    const API_BASE_URL = 'https://aacem-backend.onrender.com/api';

    // Session timeout configuration (30 minutes)
    const SESSION_TIMEOUT = 30 * 60 * 1000;
    let sessionTimer;
    let sessionTimeInterval;

    // Check authentication
    function checkAuthentication() {
      // Check sessionStorage for student data
      const studentData = sessionStorage.getItem('studentData');
      
      if (!studentData) {
        // Show login modal instead of alert
        document.getElementById('loginModal').classList.add('show');
        // Hide main content
        document.getElementById('studentMain').style.display = 'none';
        document.getElementById('studentSidebar').style.display = 'none';
        return null;
      }
      
      try {
        return JSON.parse(studentData);
      } catch (e) {
        document.getElementById('loginModal').classList.add('show');
        document.getElementById('studentMain').style.display = 'none';
        document.getElementById('studentSidebar').style.display = 'none';
        return null;
      }
    }

    // Redirect to login page
    function redirectToLogin() {
      window.location.href = 'student-login.html';
    }

    // Get student data
    const studentData = checkAuthentication();
    const STUDENT_ID = studentData ? studentData.student_id : null;

    // Check session timeout
    function checkSessionTimeout() {
      if (!studentData) return false;
      
      const loginTime = sessionStorage.getItem('loginTime');
      if (!loginTime) return false;

      const currentTime = new Date().getTime();
      const sessionStartTime = parseInt(loginTime);

      return currentTime - sessionStartTime <= SESSION_TIMEOUT;
    }

    // Logout due to timeout
    function logoutDueToTimeout() {
      sessionStorage.removeItem('studentToken');
      sessionStorage.removeItem('studentData');
      sessionStorage.removeItem('loginTime');
      
      if (sessionTimeInterval) {
        clearInterval(sessionTimeInterval);
      }
      
      document.getElementById('loginModal').classList.add('show');
      document.getElementById('studentMain').style.display = 'none';
      document.getElementById('studentSidebar').style.display = 'none';
    }

    // Start session timer (SIMPLIFIED - no timer display)
    function startSessionTimer() {
      // Clear any existing timer
      if (sessionTimer) {
        clearTimeout(sessionTimer);
      }
      
      // Set new timeout
      sessionTimer = setTimeout(logoutDueToTimeout, SESSION_TIMEOUT);
      
      // Reset timer on user activity
      const resetTimer = () => {
        if (sessionTimer) {
          clearTimeout(sessionTimer);
        }
        sessionTimer = setTimeout(logoutDueToTimeout, SESSION_TIMEOUT);
      };

      // Add event listeners
      const events = ['mousedown', 'mousemove', 'keypress', 'click', 'scroll', 'touchstart'];
      events.forEach(event => {
        document.addEventListener(event, resetTimer, false);
      });
    }

    // Main initialization
    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication
      if (!studentData || !checkSessionTimeout()) {
        document.getElementById('loginModal').classList.add('show');
        document.getElementById('studentMain').style.display = 'none';
        document.getElementById('studentSidebar').style.display = 'none';
        return;
      }
      
      // Hide login modal
      document.getElementById('loginModal').classList.remove('show');
      
      // Show content
      document.getElementById('studentMain').style.display = 'block';
      document.getElementById('studentSidebar').style.display = 'block';
      
      // Start session timer
      startSessionTimer();
      
      // Load data
      console.log('Loading student dashboard data for:', STUDENT_ID);
      updateWelcomeMessage();
      loadStudentData();
    });

    // Update welcome message
    function updateWelcomeMessage() {
      if (studentData && studentData.name) {
        document.getElementById('welcomeText').textContent = `Welcome, ${studentData.name}`;
      }
    }

    // Load all student data
    async function loadStudentData() {
      try {
        // Load all data
        await Promise.all([
          loadProfile(),
          loadAttendance(),
          loadResults(),
          loadFees(),
          loadNotices(),
          loadStudyMaterials(),
          loadSyllabus() 
        ]);
        
        await loadTimetable();
        
        console.log('All student data loaded successfully');
        
      } catch (error) {
        console.error('Error loading student data:', error);
        showError('Failed to load data. Please refresh the page.');
      }
    }

    // Load Profile Data
    async function loadProfile() {
      try {
        const response = await fetch(`${API_BASE_URL}/student-profile/${STUDENT_ID}`);
        const result = await response.json();
        
        if (result.success && result.student) {
          const student = result.student;
          
          document.getElementById('profileContent').innerHTML = `
            <div class="row">
              <div class="col-md-6">
                <p><strong>Name:</strong> ${student.name}</p>
                <p><strong>Student ID:</strong> ${student.student_id}</p>
                <p><strong>Course:</strong> ${student.course}</p>
                <p><strong>Parent Name:</strong> ${student.parent_name || 'N/A'}</p>
              </div>
              <div class="col-md-6">
                <p><strong>Join Date:</strong> ${student.join_date}</p>
                <p><strong>Phone:</strong> ${student.phone}</p>
                <p><strong>Email:</strong> ${student.email || 'N/A'}</p>
                <p><strong>Fee Status:</strong> <span class="badge bg-${getFeeStatusColor(student.fee_status)}">${student.fee_status}</span></p>
              </div>
            </div>
            ${student.address ? `<div class="mt-3"><strong>Address:</strong><br>${student.address}</div>` : ''}
          `;
        } else {
          document.getElementById('profileContent').innerHTML = `
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Profile data not available
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading profile:', error);
        document.getElementById('profileContent').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i>
            Failed to load profile data
          </div>
        `;
      }
    }

    // Load Course Syllabus
    async function loadSyllabus() {
      try {
        // First get student profile to know their course
        const profileResponse = await fetch(`${API_BASE_URL}/student-profile/${STUDENT_ID}`);
        const profileResult = await profileResponse.json();
        
        if (!profileResult.success || !profileResult.student) {
          document.getElementById('syllabusContent').innerHTML = `
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Please complete your profile to view syllabus
            </div>
          `;
          return;
        }
        
        const student = profileResult.student;
        const courseCode = student.course;
        
        if (!courseCode) {
          document.getElementById('syllabusContent').innerHTML = `
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Course information not found in your profile
            </div>
          `;
          return;
        }
        
        // Get syllabus for student's course
        const response = await fetch(`${API_BASE_URL}/syllabus/course/${courseCode}`);
        const result = await response.json();
        
        if (result.success && result.syllabus && result.syllabus.length > 0) {
          // Update section title with course name
          const sectionTitle = document.querySelector('#syllabus h4');
          if (sectionTitle) {
            sectionTitle.innerHTML = `<i class="fas fa-book-open me-2 text-primary"></i>${courseCode} - Course Syllabus`;
          }
          
          let syllabusHTML = '';
          
          result.syllabus.forEach((syllabus, index) => {
            // Only show active syllabus
            if (syllabus.is_active) {
              syllabusHTML += `
                <div class="card mb-4 border-primary">
                  <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">${syllabus.syllabus_title}</h5>
                    <span class="badge bg-light text-primary">${syllabus.total_duration} hours</span>
                  </div>
                  <div class="card-body">
                    ${syllabus.description ? `
                      <div class="mb-4">
                        <h6><i class="fas fa-info-circle me-2"></i>Description</h6>
                        <p class="text-muted">${syllabus.description}</p>
                      </div>
                    ` : ''}
                    
                    <h6 class="mb-3"><i class="fas fa-list me-2"></i>Course Curriculum</h6>
                    
                    <div class="table-responsive">
                      <table class="table table-striped table-hover">
                        <thead class="table-dark">
                          <tr>
                            <th width="5%">#</th>
                            <th width="35%">Subject</th>
                            <th width="15%">Duration</th>
                            <th width="45%">Topics Covered</th>
                          </tr>
                        </thead>
                        <tbody>
              `;
              
              // Add subjects
              if (syllabus.subjects && syllabus.subjects.length > 0) {
                syllabus.subjects.forEach((subject, idx) => {
                  const topics = subject.topics ? 
                    subject.topics.split(',').map(topic => 
                      `<span class="badge bg-info me-1 mb-1">${topic.trim()}</span>`
                    ).join(' ') : 
                    '<span class="text-muted">No topics specified</span>';
                  
                  syllabusHTML += `
                    <tr>
                      <td>${idx + 1}</td>
                      <td><strong>${subject.subject_name}</strong></td>
                      <td>${subject.duration_hours} hours</td>
                      <td>${topics}</td>
                    </tr>
                  `;
                });
              } else {
                syllabusHTML += `
                  <tr>
                    <td colspan="4" class="text-center text-muted py-3">
                      <i class="fas fa-info-circle me-2"></i>
                      Subjects will be added soon
                    </td>
                  </tr>
                `;
              }
              
              syllabusHTML += `
                        </tbody>
                        <tfoot>
                          <tr class="table-primary">
                            <td colspan="2" class="text-end"><strong>Total Duration:</strong></td>
                            <td><strong>${syllabus.total_duration} hours</strong></td>
                            <td><strong>${syllabus.subjects?.length || 0} subjects</strong></td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                    
                    <div class="mt-4 d-flex justify-content-between align-items-center">
                      <div class="text-muted small">
                        <i class="fas fa-calendar me-1"></i>
                        Updated: ${new Date(syllabus.updated_at).toLocaleDateString('en-IN')}
                      </div>
                      <button class="btn btn-sm btn-outline-primary" onclick="downloadSyllabus('${syllabus.syllabus_id}')">
                        <i class="fas fa-download me-1"></i> Download Syllabus
                      </button>
                    </div>
                  </div>
                </div>
              `;
            }
          });
          
          if (syllabusHTML === '') {
            syllabusHTML = `
              <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                No active syllabus found for your course (${courseCode}). Please check back later.
              </div>
            `;
          }
          
          document.getElementById('syllabusContent').innerHTML = syllabusHTML;
          
        } else {
          document.getElementById('syllabusContent').innerHTML = `
            <div class="text-center py-5">
              <i class="fas fa-book-open fa-4x text-muted mb-3"></i>
              <h5 class="text-muted mb-2">Syllabus Not Available Yet</h5>
              <p class="text-muted mb-0">
                The syllabus for your course (${courseCode}) is being prepared.<br>
                It will be available here once finalized by the faculty.
              </p>
            </div>
          `;
        }
        
      } catch (error) {
        console.error('Error loading syllabus:', error);
        document.getElementById('syllabusContent').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i>
            Failed to load course syllabus. Please try again later.
          </div>
        `;
      }
    }

    // Download syllabus as PDF (simple version)
    async function downloadSyllabus(syllabusId) {
      try {
        const response = await fetch(`${API_BASE_URL}/syllabus/${syllabusId}`);
        const result = await response.json();
        
        if (result.success) {
          const syllabus = result.syllabus;
          
          // Create printable content
          let content = `
            <html>
            <head>
              <title>${syllabus.syllabus_title}</title>
              <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .course-info { margin-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
                .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }
              </style>
            </head>
            <body>
              <div class="header">
                <h2>${syllabus.syllabus_title}</h2>
                <h4>${syllabus.course_name} (${syllabus.course_code})</h4>
              </div>
              
              <div class="course-info">
                <p><strong>Total Duration:</strong> ${syllabus.total_duration} hours</p>
                ${syllabus.description ? `<p><strong>Description:</strong> ${syllabus.description}</p>` : ''}
              </div>
              
              <h3>Course Subjects</h3>
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Subject Name</th>
                    <th>Duration</th>
                    <th>Topics Covered</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          if (syllabus.subjects && syllabus.subjects.length > 0) {
            syllabus.subjects.forEach((subject, index) => {
              content += `
                <tr>
                  <td>${index + 1}</td>
                  <td>${subject.subject_name}</td>
                  <td>${subject.duration_hours} hours</td>
                  <td>${subject.topics || 'N/A'}</td>
                </tr>
              `;
            });
          }
          
          content += `
                </tbody>
              </table>
              
              <div class="footer">
                <p>Generated from AACEM Student Portal on ${new Date().toLocaleDateString()}</p>
                <p>${syllabus.course_code} - ${syllabus.syllabus_title}</p>
              </div>
            </body>
            </html>
          `;
          
          // Open in new window for printing
          const printWindow = window.open('', '_blank');
          printWindow.document.write(content);
          printWindow.document.close();
          printWindow.focus();
          
          // Ask user to print
          setTimeout(() => {
            printWindow.print();
            printWindow.close();
          }, 500);
          
        } else {
          alert('Failed to download syllabus. Please try again.');
        }
      } catch (error) {
        console.error('Error downloading syllabus:', error);
        alert('Failed to download syllabus. Please try again later.');
      }
    }

    // Load Attendance Data
    async function loadAttendance() {
      try {
        const response = await fetch(`${API_BASE_URL}/student-attendance/${STUDENT_ID}`);
        const result = await response.json();
        
        if (result.success && result.attendance) {
          const attendance = result.attendance;
          
          document.getElementById('attendanceContent').innerHTML = `
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="stats-card">
                  <div class="number">${attendance.percentage}%</div>
                  <div class="label">Overall Attendance</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                  <div class="number">${attendance.present_days}</div>
                  <div class="label">Present Days</div>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <p><strong>Attendance Progress:</strong></p>
              <div class="progress">
                <div class="progress-bar ${attendance.percentage >= 75 ? 'bg-success' : attendance.percentage >= 60 ? 'bg-warning' : 'bg-danger'}" 
                  style="width: ${attendance.percentage}%">
                  ${attendance.percentage}%
                </div>
              </div>
            </div>
            <div class="row text-center">
              <div class="col-4">
                <div class="border rounded p-2 bg-light">
                  <strong>${attendance.present_days}</strong><br>
                  <small>Present</small>
                </div>
              </div>
              <div class="col-4">
                <div class="border rounded p-2 bg-light">
                  <strong>${attendance.absent_days}</strong><br>
                  <small>Absent</small>
                </div>
              </div>
              <div class="col-4">
                <div class="border rounded p-2 bg-light">
                  <strong>${attendance.total_days}</strong><br>
                  <small>Total</small>
                </div>
              </div>
            </div>
            <div class="attendance-toggle mt-3" onclick="toggleAttendanceDetails()">
              <i class="fas fa-chevron-down me-2"></i>
              View Detailed Attendance
            </div>
            <div class="attendance-details mt-3" id="attendanceDetails">
              <div class="loading">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Click above to load detailed attendance...</p>
              </div>
            </div>
          `;
        } else {
          document.getElementById('attendanceContent').innerHTML = `
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Attendance data not available
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading attendance:', error);
        document.getElementById('attendanceContent').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i>
            Failed to load attendance data
          </div>
        `;
      }
    }

    // Load detailed attendance
    async function loadDetailedAttendance() {
      try {
        const response = await fetch(`${API_BASE_URL}/student-attendance-details/${STUDENT_ID}`);
        const result = await response.json();
        
        if (result.success && result.attendance_details && result.attendance_details.length > 0) {
          const attendanceDetails = result.attendance_details;
          
          let tableHTML = `
            <div class="table-responsive">
              <table class="table table-bordered table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>Date</th>
                    <th>Day</th>
                    <th>Class</th>
                    <th>Status</th>
                    <th>Remarks</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          attendanceDetails.forEach(item => {
            const date = new Date(item.date);
            const formattedDate = date.toLocaleDateString('en-IN', {
              day: '2-digit',
              month: '2-digit', 
              year: 'numeric'
            });
            
            const dayName = date.toLocaleDateString('en-IN', { weekday: 'long' });
            
            tableHTML += `
              <tr>
                <td>${formattedDate}</td>
                <td>${dayName}</td>
                <td>${item.class || 'N/A'}</td>
                <td>
                  <span class="badge bg-${item.status === 'Present' ? 'success' : 'danger'}">
                    ${item.status}
                  </span>
                </td>
                <td>${item.remarks || '-'}</td>
              </tr>
            `;
          });
          
          tableHTML += `</tbody></table></div>`;
          
          document.getElementById('attendanceDetails').innerHTML = tableHTML;
        } else {
          document.getElementById('attendanceDetails').innerHTML = `
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              No attendance records found.
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading detailed attendance:', error);
        document.getElementById('attendanceDetails').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i>
            Failed to load attendance details
          </div>
        `;
      }
    }

    // Toggle attendance details
    async function toggleAttendanceDetails() {
      const toggle = document.querySelector('.attendance-toggle');
      const details = document.getElementById('attendanceDetails');
      
      toggle.classList.toggle('active');
      
      if (toggle.classList.contains('active')) {
        details.classList.add('show');
        await loadDetailedAttendance();
      } else {
        details.classList.remove('show');
      }
    }

    // Load Study Materials
    async function loadStudyMaterials() {
      try {
        // Get student profile
        const profileResponse = await fetch(`${API_BASE_URL}/student-profile/${STUDENT_ID}`);
        const profileResult = await profileResponse.json();
        
        if (!profileResult.success || !profileResult.student) {
          throw new Error('Unable to fetch student profile');
        }
        
        const student = profileResult.student;
        
        // Get PDFs for student's course
        const response = await fetch(`${API_BASE_URL}/course-pdfs?course=${encodeURIComponent(student.course)}`);
        const result = await response.json();
        
        if (result.success && result.pdfs && result.pdfs.length > 0) {
          // Update section header
          const sectionHeader = document.querySelector('#study-materials h4');
          if (sectionHeader) {
            sectionHeader.innerHTML = `<i class="fas fa-file-pdf me-2 text-danger"></i>Study Materials (${student.course})`;
          }
          
          // Create PDF grid
          let pdfsHTML = `<div class="row g-3">`;
          
          result.pdfs.forEach((pdf, index) => {
            const uploadDate = new Date(pdf.created_at).toLocaleDateString('en-IN');
            const fileSizeMB = pdf.file_size ? (pdf.file_size / (1024 * 1024)).toFixed(2) : '0.00';
            
            pdfsHTML += `
            <div class="col-md-6 col-lg-4">
              <div class="card h-100 border shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                  <small class="text-muted">
                    <i class="fas fa-book me-1"></i>${pdf.course_code}
                  </small>
                  <span class="badge bg-secondary">PDF ${index + 1}</span>
                </div>
                <div class="card-body d-flex flex-column">
                  <div class="d-flex align-items-start mb-3">
                    <div class="me-3">
                      <i class="fas fa-file-pdf fa-2x text-danger"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h6 class="card-title mb-1 text-truncate" title="${pdf.pdf_title}">
                        ${pdf.pdf_title}
                      </h6>
                      <div class="d-flex flex-wrap gap-2">
                        <small class="text-muted">
                          <i class="fas fa-calendar me-1"></i>${uploadDate}
                        </small>
                        <small class="text-muted">
                          <i class="fas fa-weight me-1"></i>${fileSizeMB} MB
                        </small>
                      </div>
                    </div>
                  </div>
                  
                  ${pdf.description ? `
                  <div class="mb-3 flex-grow-1">
                    <p class="card-text small text-muted" style="font-size: 0.85rem;">
                      ${pdf.description.substring(0, 80)}${pdf.description.length > 80 ? '...' : ''}
                    </p>
                  </div>
                  ` : ''}
                  
                  <div class="mt-auto pt-2 border-top">
                    <div class="d-grid gap-2">
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-success" 
                                onclick="viewStudentPdf('${pdf.pdf_id}')" 
                                title="View PDF">
                          <i class="fas fa-eye me-1"></i> View
                        </button>
                        <button type="button" class="btn btn-outline-primary" 
                                onclick="downloadStudentPdf('${pdf.pdf_id}')" 
                                title="Download PDF">
                          <i class="fas fa-download me-1"></i> Download
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            `;
          });
          
          pdfsHTML += '</div>';
          document.getElementById('pdfsContent').innerHTML = pdfsHTML;
          
        } else {
          document.getElementById('pdfsContent').innerHTML = `
            <div class="text-center py-5">
              <i class="fas fa-file-pdf fa-4x text-muted mb-3"></i>
              <h5 class="text-muted mb-2">No Study Materials Available</h5>
              <p class="text-muted mb-0">Study materials for your course (${student.course}) will appear here once uploaded by faculty.</p>
            </div>
          `;
        }
        
      } catch (error) {
        console.error('Error loading study materials:', error);
        document.getElementById('pdfsContent').innerHTML = `
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Failed to load study materials. Please check your connection.
          </div>
        `;
      }
    }

    // View PDF
    function viewStudentPdf(pdfId) {
      window.open(`${API_BASE_URL}/view-course-pdf/${pdfId}`, '_blank');
    }

    // Download PDF
    function downloadStudentPdf(pdfId) {
      window.open(`${API_BASE_URL}/view-course-pdf/${pdfId}?download=true`, '_blank');
    }

    // Load Timetable
    async function loadTimetable() {
      try {
        const response = await fetch(`${API_BASE_URL}/student-timetable/${STUDENT_ID}`);
        const result = await response.json();
        
        if (result.success && result.timetable && result.timetable.length > 0) {
          let tableHTML = `
            <div class="table-responsive">
              <table class="table table-bordered table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>Day</th>
                    <th>Subject</th>
                    <th>Teacher</th>
                    <th>Time</th>
                    <th>Room</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          result.timetable.forEach(item => {
            tableHTML += `
              <tr>
                <td>${item.day || 'N/A'}</td>
                <td>${item.subject || 'N/A'}</td>
                <td>${item.teacher_name || 'N/A'}</td>
                <td>${item.start_time || 'N/A'} - ${item.end_time || 'N/A'}</td>
                <td>${item.room_number || 'N/A'}</td>
              </tr>
            `;
          });
          
          tableHTML += `</tbody></table></div>`;
          document.getElementById('timetableContent').innerHTML = tableHTML;
        } else {
          document.getElementById('timetableContent').innerHTML = `
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              Timetable will be updated soon.
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading timetable:', error);
        document.getElementById('timetableContent').innerHTML = `
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Timetable will be updated soon.
          </div>
        `;
      }
    }

    // Load Results
    async function loadResults() {
      try {
        const response = await fetch(`${API_BASE_URL}/student-results/${STUDENT_ID}`);
        const result = await response.json();
        
        if (result.success && result.results && result.results.length > 0) {
          let tableHTML = `
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>Subject</th>
                    <th>Exam Type</th>
                    <th>Marks Obtained</th>
                    <th>Total Marks</th>
                    <th>Percentage</th>
                    <th>Grade</th>
                    <th>Exam Date</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          result.results.forEach(item => {
            const percentage = ((item.marks_obtained / item.total_marks) * 100).toFixed(1);
            
            tableHTML += `
              <tr>
                <td>${item.subject}</td>
                <td>${item.exam_type}</td>
                <td>${item.marks_obtained}</td>
                <td>${item.total_marks}</td>
                <td>${percentage}%</td>
                <td><span class="badge bg-${getGradeColor(item.grade)}">${item.grade}</span></td>
                <td>${item.exam_date}</td>
              </tr>
            `;
          });
          
          tableHTML += `</tbody></table></div>`;
          document.getElementById('resultsContent').innerHTML = tableHTML;
        } else {
          document.getElementById('resultsContent').innerHTML = `
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              No results available yet.
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading results:', error);
        document.getElementById('resultsContent').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i>
            Failed to load results
          </div>
        `;
      }
    }

    // Load Fees
    async function loadFees() {
      try {
        const response = await fetch(`${API_BASE_URL}/student-fees/${STUDENT_ID}`);
        const result = await response.json();
        
        if (result.success && result.fee_details) {
          const fees = result.fee_details;
          const paidAmount = parseFloat(fees.paid_amount) || 0;
          const totalAmount = parseFloat(fees.fee_amount) || 0;
          const dueAmount = parseFloat(fees.due_amount) || 0;
          const paymentStatus = fees.fee_status || 'Pending';
          
          const paymentProgress = totalAmount > 0 ? (paidAmount / totalAmount) * 100 : 0;
          
          document.getElementById('feesContent').innerHTML = `
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="border rounded p-3 bg-light mb-3 text-center">
                  <h6 class="text-muted">Total Fees</h6>
                  <h4 class="text-primary">₹${totalAmount.toLocaleString('en-IN')}</h4>
                </div>
              </div>
              <div class="col-md-3">
                <div class="border rounded p-3 bg-light mb-3 text-center">
                  <h6 class="text-muted">Paid Amount</h6>
                  <h4 class="text-success">₹${paidAmount.toLocaleString('en-IN')}</h4>
                </div>
              </div>
              <div class="col-md-3">
                <div class="border rounded p-3 bg-light mb-3 text-center">
                  <h6 class="text-muted">Due Amount</h6>
                  <h4 class="text-danger">₹${dueAmount.toLocaleString('en-IN')}</h4>
                </div>
              </div>
              <div class="col-md-3">
                <div class="border rounded p-3 bg-light mb-3 text-center">
                  <h6 class="text-muted">Status</h6>
                  <h4><span class="badge bg-${getFeeStatusColor(paymentStatus)}">${paymentStatus}</span></h4>
                </div>
              </div>
            </div>
            <div class="mb-4">
              <p><strong>Payment Progress:</strong></p>
              <div class="progress">
                <div class="progress-bar bg-success" style="width: ${paymentProgress}%">
                  ${paymentProgress.toFixed(1)}%
                </div>
              </div>
            </div>
            ${dueAmount > 0 ? `
            <button class="btn btn-success" onclick="payFees()">
              <i class="fas fa-credit-card me-2"></i>Pay Online
            </button>
            ` : `
            <div class="alert alert-success">
              <i class="fas fa-check-circle me-2"></i>
              All fees have been paid. Thank you!
            </div>
            `}
          `;
        } else {
          document.getElementById('feesContent').innerHTML = `
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Fee details not available
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading fees:', error);
        document.getElementById('feesContent').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i>
            Failed to load fee details
          </div>
        `;
      }
    }

    // Load Notices
    async function loadNotices() {
      try {
        const response = await fetch(`${API_BASE_URL}/student-notices`);
        const result = await response.json();
        
        if (result.success && result.notices && result.notices.length > 0) {
          let noticesHTML = '<div class="list-group">';
          
          result.notices.forEach(notice => {
            const noticeDate = new Date(notice.created_at).toLocaleDateString();
            const priorityClass = notice.priority === 'high' ? 'list-group-item-danger' : 
                                notice.priority === 'medium' ? 'list-group-item-warning' : '';
            
            noticesHTML += `
            <div class="list-group-item ${priorityClass}">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${notice.title}</h6>
                <small class="text-muted">${noticeDate}</small>
              </div>
              <p class="mb-1">${notice.message}</p>
              ${notice.priority === 'high' ? '<small class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>Important Notice</small>' : ''}
            </div>
            `;
          });
          
          noticesHTML += '</div>';
          document.getElementById('noticesContent').innerHTML = noticesHTML;
        } else {
          document.getElementById('noticesContent').innerHTML = `
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              No notices at the moment
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading notices:', error);
        document.getElementById('noticesContent').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i>
            Failed to load notices
          </div>
        `;
      }
    }

    // Helper functions
    function getGradeColor(grade) {
      switch(grade) {
        case 'A+': case 'A': return 'success';
        case 'B': case 'B+': return 'info';
        case 'C': case 'C+': return 'warning';
        default: return 'danger';
      }
    }

    function getFeeStatusColor(status) {
      switch(status) {
        case 'Paid': return 'success';
        case 'Partial': return 'warning';
        case 'Pending': return 'danger';
        default: return 'secondary';
      }
    }

    // Pay fees function
    function payFees() {
      alert('Payment gateway integration would be implemented here. Please contact administration for fee payment.');
    }

    // Show error message
    function showError(message) {
      console.error('Dashboard Error:', message);
      alert(message);
    }

    // Logout function
    function logout() {
      const confirmLogout = confirm("Are you sure you want to log out?");
      
      if (confirmLogout) {
        // Clear all session data
        sessionStorage.removeItem('studentToken');
        sessionStorage.removeItem('studentData');
        sessionStorage.removeItem('loginTime');
        
        // Clear session timer
        clearTimeout(sessionTimer);
        
        alert("You have been logged out!");
        window.location.href = "index.html";
      }
    }
  </script>
</body>
</html>
